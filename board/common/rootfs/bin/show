#!/bin/sh
# Displays basic information about the system
# shellcheck disable=SC2048,SC2086
. /etc/os-release

H1=$(printf '\033[7m')
H2=$(printf '\033[1m')
DM=$(printf '\033[2m')
UL=$(printf '\033[4m')
IT=$(printf '\033[3m')
BL=$(printf '\033[5m')
H0=$(printf '\033[0m')

opt="-br"
all=""
plain=""

TTY=$(resize)
eval "$TTY"

noansi()
{
        H1=""
        H2=""
        DM=""
        UL=""
        IT=""
        BL=""
        H0=""
}

usage()
{
	cat <<EOF
usage:
  show [opt] cmd

options:
  -a            Show all, of something
  -f            Show full output, not brief port/iface listings
  -h            Show this help text
  -p            Show plain output, now bells or whistles

commands:
  port PORT     Show port configuration and link information
  ports         Show ports available for bridging
  vlans         Show port groups in bridge
  ifaces        Show interfaces and their addresses
  fdb           Show forwarding database (unicast)
  mdb           Show multicast forwarding database
  ip route      Show routing table
  log [FILE]    Show latest entries from syslog, or other FILE
  rmon PORT     Show RMON counters for PORT (when applicable)
  system        Show OS details
  version       Show OS verson
EOF
}

# Usage 1: show port eth0
# Usage 2: show port
# Usage 3: show ports
#
# The first show ethtool output for 'eth0' (in this case).  The latter
# two are the same, showing a summary of all interfaces classified as
# access ports.
ports()
{
	if [ $# -gt 0 ] && [ -e "/sys/class/net/$1" ]; then
		for port in $*; do
			ethtool "$port"
		done
		return
	fi

	echo "${H1}PORT             STATE          ADDRESS <FLAGS>                               ${H0}"
	if grep -q port /etc/iproute2/group && [ -z "$all" ]; then
		ip $opt link show group port
	else
		ip $opt link show
	fi

	if [ -z "$plain" ]; then
		echo "${DM}______________________________________________________________________________${H0}"
		echo "${DM}Use: '[ip|bridge] --help' and '[ip|bridge] link help' for more details.${H0}"
	fi
}

vlans()
{
	printf "${H1}INTERFACE         VLAN  FLAGS                                                 ${H0}\n"
	bridge vlan show |tail +2 | awk 'NF { iface=$1; vid=$2; printf("%-16s  %4d  ", iface, vid); for (i=3; i <= NF; i++) printf("%s ", $i); printf("\n"); }'
	if [ -z "$plain" ]; then
		echo "${DM}______________________________________________________________________________${H0}"
		echo "${DM}See: 'bridge --help' and 'bridge vlan help' for more details.${H0}"
	fi
}

ifaces()
{
	printf "${H1}INTERFACE        STATE          ADDRESS                                       ${H0}\n"
	if [ -n "$all" ]; then
		ip $opt addr show
        elif grep -q iface /etc/iproute2/group; then
                ip $opt addr show group iface
	else
		ip $opt addr show |awk '{ if ($1 !~ /eth[0-9]*/ && $1 !~ /.*@NONE/) { print }}'
	fi
	if [ -z "$plain" ]; then
		echo "${DM}______________________________________________________________________________${H0}"
		echo "${DM}See: 'ip --help' and 'ip address help' for more details.${H0}"
	fi
}

log()
{
	if [ -n "$1" ] && [ -r "/var/log/$1" ]; then
		fn="/var/log/$1"
	else
		fn="/var/log/syslog"
	fi
	if [ -n "$all" ]; then
		cat $fn
	else
		tail -$LINES $fn
	fi
	if [ -z "$plain" ]; then
		echo "${DM}______________________________________________________________________________${H0}"
		echo "${DM}See: 'tail -25 /log/FILE', 'tail -F /log/FILE' to continuously monitor files.${H0}"
	fi
}

rmon()
{
	if [ -z "$*" ]; then
		echo "Missing argument, see 'show port' for available interfaces"
		exit 1
	fi
	for port in $*; do
		ethtool -S "$port"
	done
	if [ -z "$plain" ]; then
		echo "${DM}______________________________________________________________________________${H0}"
		echo "${DM}See: 'ethtool --help' for more details.${H0}"
	fi
}

rstp()
{
	mstpctl showbridge
	echo "br0 port info"
	mstpctl showport br0
}

fdb()
{
	bridge -color fdb show
}

mdb()
{
	bridge -color mdb show
}

routes()
{
	ip -color route show
}

igmp()
{
	querierctl $@
}

system()
{
	echo "${H1}SYSTEM INFORMATION                                                            ${H0}"
	echo "System Name        : $(uname -n)"
	echo "System Description : $PRETTY_NAME"
	echo "System Contact     : $HOME_URL"
	echo "System Timezone    : $TZ"
	echo "System Type        : $NAME"
	echo "System Version     : $(cat /etc/version)"
	echo "System Arch        : $(uname -m)"
	echo "Kernel Version     : $(uname -sr)"
}

version()
{
	cat /etc/version
}

while [ "$1" != "" ]; do
	case $1 in
		-a)
			all=1
			;;
		-f)
			opt=""
			;;
		-p)
			plain="yes"
			noansi
			;;
		-h)
			usage
			exit 0
			;;
		*)
			break
	esac
	shift
done

cmd=$1
if [ -n "$cmd" ]; then
	shift
fi

case $cmd in
	help)
		usage
		;;
	port*)
		shift
		ports $*
		;;
	vlan*)
		vlans
		;;
	fdb)
		fdb
		;;
	mdb)
		mdb
		;;
	if*)
		ifaces
		;;
	ip)
		cmd=$1
		shift
		case $cmd in
			addr*)
				ifaces
				;;
			route*)
				routes
				;;
			igmp*)
				igmp $*
				;;
			*)
				usage
				;;
		esac
		;;
	log)
		log $1
		;;
	rmon)
		rmon $*
		;;
	route*)
		routes
		;;
	span*)
		rstp
		;;
	sys*)
		system
		;;
	ver*)
		version
		;;
	*)
		usage
		exit 1
		;;
esac
